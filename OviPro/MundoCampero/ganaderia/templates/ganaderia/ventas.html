{% extends 'ganaderia/layout.html' %}

{% block body %}
<div class="container-fluid py-4 min-vh-100">
    <div class="row mb-4 align-items-center">
        <div class="col-auto">
            <a href="{% url 'ganaderia:dashboard' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Volver al Dashboard
            </a>
        </div>
        <div class="col">
            <h1 class="display-4 text-center mb-0">Ventas</h1>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>RP</th>
                            <th>Peso(kg)</th>
                            <th>Edad</th>
                            <th>Pureza</th>
                            <th>Tipo</th>
                            <th>Fecha</th>
                            <th>Sexo</th>
                            <th>Valor(USD)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for venta in ventas %}
                            {% for oveja in venta.ovejas.all %}
                                <tr>
                                    <td>{{ oveja.RP }}</td>
                                    <td>{{ oveja.peso }}</td>
                                    <td>{{ oveja.edad_clasificada|default:"Edad no disponible" }}</td>
                                    <td>{{ oveja.calificador_pureza }}</td>
                                    <td>{{ venta.tipo_venta }}</td>
                                    <td>{{ venta.fecha_venta }}</td>
                                    <td>{{ venta.valor }}</td>
                                </tr>
                            {% endfor %}
                        {% empty %}
                            <tr>
                                <td colspan="9" class="text-center">No hay ventas registradas</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="mt-4 d-flex justify-content-between align-items-center">
        <div>
            <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addSaleModal">
                <i class="fas fa-plus"></i> Agregar venta
            </button>
        </div>
        <div>
            <button class="btn btn-secondary" id="downloadTableBtn">
                <i class="fas fa-download"></i> Descargar tabla
            </button>
        </div>
    </div>
</div>

    <!--  -->
<!-- Add Sale Modal -->
<div class="modal fade" id="addSaleModal" tabindex="-1" aria-labelledby="addSaleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSaleModalLabel">Registrar Nueva Venta de Ovinos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addSaleForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="saleType" class="form-label">Tipo de Venta</label>
                        <select class="form-select" id="saleType" required>
                            <option value="">Seleccione el tipo de venta</option>
                            <option value="frigorifico">Frigorífico</option>
                            <option value="remate">Remate</option>
                            <option value="individual">Venta Individual</option>
                            <option value="donacion">Donación</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="batchSale">
                            <label class="form-check-label" for="batchSale">
                                Venta por Lote (máximo 10 animales)
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="animalSelect" class="form-label">Seleccionar ovinos</label>
                        <select class="form-select" id="animalSelect" multiple>
                            <!-- Options will be populated dynamically -->
                             {% for ovejas in lista_ovejas %}
                                <option value="{{ ovejas.RP }}">{{ ovejas.RP }}</option>
                             {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Animales Seleccionados</label>
                        <ul id="selectedAnimals" class="list-group">
                            <!-- Selected animals will be displayed here -->
                        </ul>
                    </div>

                    <div id="frigorificoFields" style="display: none;">
                        <div class="mb-3">
                            <label for="totalWeight" class="form-label">Peso Total (kg)</label>
                            <input type="number" class="form-control" id="totalWeight" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="pricePerKg" class="form-label">Precio por kg ($)</label>
                            <input type="number" class="form-control" id="pricePerKg" step="0.01" required>
                        </div>
                    </div>

                    <div id="remateFields" style="display: none;">
                        <div class="mb-3">
                            <label for="remateTotal" class="form-label">Valor Total del Remate ($)</label>
                            <input type="number" class="form-control" id="remateTotal" step="0.01" required>
                        </div>
                    </div>

                    <div id="individualFields" style="display: none;">
                        <!-- Individual sale prices will be dynamically added here -->
                    </div>

                    <div class="mb-3">
                        <label for="saleDate" class="form-label">Fecha de Venta</label>
                        <input type="date" class="form-control" id="saleDate" required>
                    </div>

                    <div class="mb-3">
                        <label for="totalSaleValue" class="form-label">Valor Total de la Venta ($)</label>
                        <input type="number" class="form-control" id="totalSaleValue" readonly>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmSale">Confirmar Venta</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Venta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Por favor, confirme los detalles de la venta:</p>
                <div id="saleDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="finalConfirmSale">Confirmar y Guardar</button>
            </div>
        </div>
    </div>
</div>




{% endblock %}

{% block scripts %}
<script>

document.addEventListener('DOMContentLoaded', function() {
    const saleType = document.getElementById('saleType');
    const batchSale = document.getElementById('batchSale');
    const animalSelect = document.getElementById('animalSelect');
    const selectedAnimals = document.getElementById('selectedAnimals');
    const frigorificoFields = document.getElementById('frigorificoFields');
    const remateFields = document.getElementById('remateFields');
    const individualFields = document.getElementById('individualFields');
    const totalWeight = document.getElementById('totalWeight');
    const pricePerKg = document.getElementById('pricePerKg');
    const remateTotal = document.getElementById('remateTotal');
    const totalSaleValue = document.getElementById('totalSaleValue');
    const confirmSaleBtn = document.getElementById('confirmSale');
    const finalConfirmSaleBtn = document.getElementById('finalConfirmSale');

    // Mock data for available animals
    const availableAnimals = [
        { rp: 'RP001', weight: 50 },
        { rp: 'RP002', weight: 55 },
        { rp: 'RP003', weight: 48 },
        { rp: 'RP004', weight: 52 },
        { rp: 'RP005', weight: 58 },
        // Add more animals as needed
    ];

    // Populate animal select options
    availableAnimals.forEach(animal => {
        const option = new Option(animal.rp, animal.rp);
        animalSelect.add(option);
    });

    saleType.addEventListener('change', updateFormFields);
    batchSale.addEventListener('change', updateAnimalSelection);
    animalSelect.addEventListener('change', updateSelectedAnimals);
    pricePerKg.addEventListener('input', calculateFrigorificoTotal);
    remateTotal.addEventListener('input', updateTotalSaleValue);
    confirmSaleBtn.addEventListener('click', showConfirmation);
    finalConfirmSaleBtn.addEventListener('click', submitSaleForm);

    function updateFormFields() {
        frigorificoFields.style.display = saleType.value === 'frigorifico' ? 'block' : 'none';
        remateFields.style.display = saleType.value === 'remate' ? 'block' : 'none';
        individualFields.style.display = saleType.value === 'individual' ? 'block' : 'none';
        
        if (saleType.value === 'donacion') {
            totalSaleValue.value = '0';
        }
        
        updateAnimalSelection();
        updateSelectedAnimals();
    }

    function updateAnimalSelection() {
        animalSelect.multiple = !batchSale.checked;
        if (batchSale.checked) {
            Array.from(animalSelect.selectedOptions).slice(10).forEach(option => option.selected = false);
        }
    }

    function updateSelectedAnimals() {
        selectedAnimals.innerHTML = '';
        let totalWeightValue = 0;
        
        Array.from(animalSelect.selectedOptions).forEach(option => {
            const animal = availableAnimals.find(a => a.rp === option.value);
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.textContent = animal.rp;
            
            if (saleType.value === 'individual') {
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'form-control form-control-sm w-25';
                input.placeholder = 'Precio';
                input.addEventListener('input', calculateIndividualTotal);
                li.appendChild(input);
            }
            
            selectedAnimals.appendChild(li);
            totalWeightValue += animal.weight;
            option.style.color = 'green';
        });

        availableAnimals.forEach(animal => {
            const option = animalSelect.querySelector(`option[value="${animal.rp}"]`);
            if (!option.selected) {
                option.style.color = '';
            }
        });

        totalWeight.value = totalWeightValue;
        calculateFrigorificoTotal();
    }

    function calculateFrigorificoTotal() {
        if (saleType.value === 'frigorifico') {
            const total = (parseFloat(totalWeight.value) || 0) * (parseFloat(pricePerKg.value) || 0);
            totalSaleValue.value = total.toFixed(2);
        }
    }

    function calculateIndividualTotal() {
        if (saleType.value === 'individual') {
            let total = 0;
            selectedAnimals.querySelectorAll('input').forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            totalSaleValue.value = total.toFixed(2);
        }
    }

    function updateTotalSaleValue() {
        if (saleType.value === 'remate') {
            totalSaleValue.value = remateTotal.value;
        }
    }

    function showConfirmation() {
        const saleDetails = document.getElementById('saleDetails');
        let detailsHTML = `
            <p><strong>Tipo de Venta:</strong> ${saleType.options[saleType.selectedIndex].text}</p>
            <p><strong>Fecha de Venta:</strong> ${document.getElementById('saleDate').value}</p>
            <p><strong>Valor Total:</strong> $${totalSaleValue.value}</p>
            <p><strong>Animales Vendidos:</strong></p>
            <ul>
        `;

        Array.from(animalSelect.selectedOptions).forEach(option => {
            detailsHTML += `<li>${option.text}</li>`;
        });

        detailsHTML += '</ul>';

        if (saleType.value === 'frigorifico') {
            detailsHTML += `
                <p><strong>Peso Total:</strong> ${totalWeight.value} kg</p>
                <p><strong>Precio por kg:</strong> $${pricePerKg.value}</p>
            `;
        }

        saleDetails.innerHTML = detailsHTML;
        const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        confirmationModal.show();
    }

    function submitSaleForm() {
        // Here you would typically send the form data to your server
        console.log('Sale form submitted', {
            type: saleType.value,
            animals: Array.from(animalSelect.selectedOptions).map(o => o.value),
            totalValue: totalSaleValue.value,
            date: document.getElementById('saleDate').value
        });
        // Close both modals
        bootstrap.Modal.getInstance(document.getElementById('confirmationModal')).hide();
        bootstrap.Modal.getInstance(document.getElementById('addSaleModal')).hide();
        // Reset the form
        document.getElementById('addSaleForm').reset();
    }
});



   
</script>
{% endblock %}


